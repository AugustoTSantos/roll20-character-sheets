<div class="principal">
  <!-- Inicio primeira linha do cabeçalho -->
  <div class="sheet-table left classHeader">
    <div class="sheet-table-row">
      <span class="sheet-table-data long">
        <label>Nome</label>
      </span>
      <span class="sheet-table-data">
        <input
          name="attr_nome_personagem"
          type="text"
          placeholder="José da Silva"
          style="width: 100%"
        />
      </span>

      <span class="sheet-table-data" style="width: 15px"></span>

      <span class="sheet-table-data">
        <label>Aparencia</label>
      </span>
      <span class="sheet-table-data">
        <input
          name="attr_aparencia_personagem"
          type="text"
          placeholder="alto e moreno de olhos castanhos"
          style="width: 100%"
        />
      </span>
    </div>
    <!-- Fim sheet-table-row -->
  </div>
  <!-- Fim sheet-table left classHeader -->
  <!-- Fim primeira linha do cabeçalho -->

  <!-- Inicio segunda linha do cabeçalho -->
  <div class="sheet-table left classHeader">
    <div class="sheet-table-row">
      <span class="sheet-table-data long">
        <label>Pseudôminos</label>
      </span>
      <span class="sheet-table-data">
        <input
          name="attr_pseudominos_personagem"
          type="text"
          placeholder="Zé"
          style="width: 100%"
        />
      </span>

      <span class="sheet-table-data" style="width: 15px"></span>

      <span class="sheet-table-data long">
        <label>Idade</label>
      </span>
      <span class="sheet-table-data">
        <input
          name="attr_idade_personagem"
          type="number"
          value="0"
          style="width: 100%"
        />
      </span>

      <span class="sheet-table-data" style="width: 15px"></span>

      <span class="sheet-table-data long">
        <label>Sexo</label>
      </span>
      <span class="sheet-table-data">
        <input
          name="attr_pseudominos_personagem"
          type="text"
          placeholder="Masculino"
          style="width: 100%"
        />
      </span>
    </div>
    <!-- Fim sheet-table-row -->
  </div>
  <!-- Fim sheet-table left classHeader -->
  <!-- Fim segunda linha do cabeçalho -->

  <!-- Inicio terceira linha do cabeçalho -->
  <div class="sheet-table left classHeader">
    <div class="sheet-table-row">
      <span class="sheet-table-data long">
        <label>Conceito</label>
      </span>
      <span class="sheet-table-data">
        <input
          name="attr_conceito_personagem"
          type="text"
          placeholder="Samurai Renegado"
          style="width: 100%"
        />
      </span>

      <span class="sheet-table-data" style="width: 15px"></span>

      <span class="sheet-table-data long">
        <label>XP Total</label>
      </span>
      <span class="sheet-table-data">
        <input
          name="attr_xp_total_personagem"
          type="number"
          value="0"
          style="width: 100%"
        />
      </span>

      <span class="sheet-table-data" style="width: 15px"></span>

      <span class="sheet-table-data long">
        <label>XP Gasto</label>
      </span>
      <span class="sheet-table-data">
        <input
          name="attr_xp_gasto_personagem"
          type="number"
          value="0"
          readonly
          style="width: 100%"
        />
      </span>

      <span class="sheet-table-data" style="width: 15px"></span>

      <span class="sheet-table-data long">
        <label>XP Livre</label>
      </span>
      <span class="sheet-table-data">
        <input
          name="attr_xp_livre_personagem"
          type="number"
          value="0"
          readonly
          style="width: 100%"
        />
      </span>
    </div>
    <!-- Fim sheet-table-row -->
  </div>
  <!-- Fim sheet-table left classHeader -->
  <!-- Fim terceira linha do cabeçalho -->

  <!-- hr pra adicionar um espaço com uma linha. -->
  <hr />

  <div class="sheet-2colrow bot-margin">
    <!-- Inicio atributos -->
    <div class="sheet-col">
      <label class="sheet-textHead2Col">Atributos</label>

      <div class="atributes-grid center">
        <span class="vertical-center grid-title">Nome</span>
        <span class="vertical-center grid-title">Base</span>
        <span class="vertical-center grid-title">Nivel</span>
        <span class="vertical-center grid-title">Mod</span>
        <span class="vertical-center grid-title">Total</span>
        <span class="vertical-center grid-title">%</span>
        <span class="vertical-center grid-title">XP</span>

        <div class="atributo_forca">
          <span class="sheet-col1 vertical-center">Força</span>
          <input name="attr_base" type="number" value="0" readonly />
          <input name="attr_for_nivel" type="number" value="0" />
          <input name="attr_for_mod" type="number" value="0" />
          <input name="attr_for_total" type="number" value="0" readonly />
          <input
            name="attr_for_porcent"
            type="number"
            value="0"
            readonly
          />
          <input name="attr_for_xp" type="number" value="0" />
        </div>
        <!-- Fim atributo_forca -->

        <div class="atributo_agilidade">
          <span class="sheet-col1 vertical-center">Agilidade</span>
          <input name="attr_base" type="number" value="0" readonly />
          <input name="attr_agi_nivel" type="number" value="0" />
          <input name="attr_agi_mod" type="number" value="0" />
          <input name="attr_agi_total" type="number" value="0" readonly />
          <input
            name="attr_agi_porcent"
            type="number"
            value="0"
            readonly
            />
          <input name="attr_agi_xp" type="number" value="0" />
        </div>
        <!-- Fim atributo_agilidade -->

        <div class="atributo_vigor">
          <span class="sheet-col1 vertical-center">Vigor</span>
          <input name="attr_base" type="number" value="0" readonly />
          <input name="attr_vig_nivel" type="number" value="0" />
          <input name="attr_vig_mod" type="number" value="0" />
          <input name="attr_vig_total" type="number" value="0" readonly />
          <input
            name="attr_vig_porcent"
            type="number"
            value="0"
            readonly
          />
          <input name="attr_vig_xp" type="number" value="0" />
        </div>
        <!-- Fim atributo_vigor -->

        <div class="atributo_intelecto">
          <span class="sheet-col1 vertical-center">Intelecto</span>
          <input name="attr_base" type="number" value="0" readonly />
          <input name="attr_int_nivel" type="number" value="0" />
          <input name="attr_int_mod" type="number" value="0" />
          <input name="attr_int_total" type="number" value="0" readonly />
          <input
            name="attr_int_porcent"
            type="number"
            value="0"
            readonly
          />
          <input name="attr_int_xp" type="number" value="0" />
        </div>
        <!-- Fim atributo_intelecto -->

        <div class="atributo_percepcao">
          <span class="sheet-col1 vertical-center">Percepção</span>
          <input name="attr_base" type="number" value="0" readonly />
          <input name="attr_per_nivel" type="number" value="0" />
          <input name="attr_per_mod" type="number" value="0" />
          <input name="attr_per_total" type="number" value="0" readonly />
          <input
            name="attr_per_porcent"
            type="number"
            value="0"
            readonly
          />
          <input name="attr_per_xp" type="number" value="0" />
        </div>
        <!-- Fim atributo_percepcao -->

        <div class="atributo_vontade">
          <span class="sheet-col1 vertical-center">Vontade</span>
          <input name="attr_base" type="number" value="0" readonly />
          <input name="attr_von_nivel" type="number" value="0" />
          <input name="attr_von_mod" type="number" value="0" />
          <input name="attr_von_total" type="number" value="0" readonly />
          <input
            name="attr_von_porcent"
            type="number"
            value="0"
            readonly
          />
          <input name="attr_von_xp" type="number" value="0" />
        </div>
        <!-- Fim atributo_vontade -->

        <span class="sheet-col1 vertical-center">XP Total</span>
        <input
          name="attr_xp_total_atributos"
          type="number"
          value="0"
          readonly
        />
      </div>
      <!-- Fim atributes-grid center -->
      <!-- Fim atributos -->

      <hr />

      <!-- Inicio atributos secundários -->
      <label class="sheet-textHead2Col">Atributos Secundários</label>
      <label>Vitalidade</label>
      <div class="sub_atributo_vitalidade">
        Base
        <input
          name="attr_sub_vit_base"
          type="number"
          value="0"
          readonly
        />

        Mod
        <input name="attr_sub_vit_mod" type="number" value="0" />

        Total
        <input
          name="attr_sub_vit_total"
          type="number"
          value="0"
          readonly
        />
      </div>
      <!-- Fim sub_atributo_vitalidade -->

      <label>Iniciativa</label>
      <div class="sub_atributo_iniciativa">
        Base
        <input
          name="attr_sub_ini_base"
          type="number"
          value="0"
          readonly
        />

        Mod
        <input name="attr_sub_ini_mod" type="number" value="0" />

        Total
        <input
          name="attr_sub_ini_total"
          type="number"
          value="0"
          readonly
        />
      </div>
      <!-- Fim sub_atributo_iniciativa -->

      <label>Mod de Dano</label>
      <div class="sub_atributo_mod_dano">
        Base
        <input
          name="attr_sub_mod_dano_base"
          type="number"
          value="0"
          readonly
        />

        Mod
        <input name="attr_sub_mod_dano_mod" type="number" value="0" />

        Total
        <input
          name="attr_sub_mod_dano_total"
          type="number"
          value="0"
          readonly
        />
      </div>
      <!-- Fim sub_atributo_mod_dano -->

      <label>Sanidade</label>
      <div class="sub_atributo_sanidade">
        Base
        <input
          name="attr_sub_san_base"
          type="number"
          value="0"
          readonly
        />

        Mod
        <input name="attr_sub_san_mod" type="number" value="0" />

        Total
        <input
          name="attr_sub_san_total"
          type="number"
          value="0"
          readonly
        />
      </div>
      <!-- Fim sub_atributo_sanidade -->

      <label>Raciocínio</label>
      <div class="sub_atributo_raciocinio">
        Base
        <input
          name="attr_sub_rac_base"
          type="number"
          value="0"
          readonly
        />

        Mod
        <input name="attr_sub_rac_mod" type="number" value="0" />

        Total
        <input
          name="attr_sub_rac_total"
          type="number"
          value="0"
          readonly
        />
      </div>

      <!-- Fim sub_atributo_raciocinio -->
      <label>Estresse</label>
      <div class="sub_atributo_estresse">
        Base
        <input
          name="attr_sub_est_base"
          type="number"
          value="0"
          readonly
        />

        Mod
        <input name="attr_sub_est_mod" type="number" value="0" />

        Total
        <input
          name="attr_sub_est_total"
          type="number"
          value="0"
          readonly
        />
      </div>
      <!-- Fim sub_atributo_estresse -->
      <!-- Fim atributos secundários -->

      <hr />

      <!-- Inicio inicio traços e condições -->
      <label class="sheet-textHead2Col">Traços e Condições</label>
      <div class="tracos_condicoes">
        Nome XP
        <fieldset class="repeating_caixatracoscondicoes">
          <!-- Inicio primeira linha caixa tracoscondicoes -->
          <div class="caixa_tabela">
            <div class="caixa_tabela_linha">
              <span>
                <input
                  name="attr_nome_traco_condicao"
                  type="text"
                  placeholder="nome do traço ou condição"
                />
              </span>
              <span>
                <input name="attr_xp_traco_condicao" type="number" value="0" />
              </span>
            </div>
            <!-- Fim caixa_tabela_linha -->
          </div>
          <!-- Fim caixa_tabela -->
          <!-- Fim primeira linha tracoscondicoes -->
          <br />
          <!-- Inicio caixas de descrição -->
          <div class="caixa_tabela_linha">
            <span class="informacao_tabela">
              <div class="caixa_tabela">
                <div class="caixa_tabela_linha">
                  <span class="informacao_tabela">
                    <textarea
                      class="descricao_traco_condicao"
                      name="attr_descricao_traco_condicao"
                      type="text"
                      placeholder="descrição do traço ou condição">
                    </textarea>
                  </span>
                </div>
                <!-- Fim caixa_tabela_linha -->
              </div>
              <!-- Fim caixa_tabela -->
            </span>
            <br />
          </div>
          <!-- Fim caixa_tabela_linha -->
          <!-- Fim caixas de descrição -->
        </fieldset>
        XP Total
        <input
          name="attr_xp_total_tracos_condicoes"
          type="number"
          value="0"
          readonly
        />
      </div>
      <!-- Fim tracos_condicoes -->
      <!-- Fim traços e condições -->
    </div>
    <!-- Fim sheet-col -->

    <!-- Inicio Habilidades -->
    <div class="sheet-col">
      <label class="sheet-textHead2Col">Habilidades</label>

      <span class="vertical-center grid-title">Nome</span>
      <span class="vertical-center grid-title">Nivel</span>
      <span class="vertical-center grid-title">Mod</span>
      <span class="vertical-center grid-title">Total</span>
      <span class="vertical-center grid-title">%</span>
      <span class="vertical-center grid-title">XP</span>

      <fieldset class="repeating_caixahabilidades">
        <!-- Inicio primeira linha caixa habilidades -->
        <div class="caixa_tabela">
          <div class="caixa_tabela_linha">
            <span>
              <input
                name="attr_hab_nome"
                type="text"
                placeholder="nome da habilidade"
              />
            </span>
            <span>
              <input name="attr_hab_nivel" type="number" value="0" />
            </span>
            <span>
              <input name="attr_hab_mod" type="number" value="0" />
            </span>
            <span>
              <input name="attr_hab_total" type="number" value="0" readonly />
            </span>
            <span>
              <input name="attr_hab_porcent" type="number" value="0" readonly />
            </span>
            <span>
              <input name="attr_hab_xp" type="number" value="0" />
            </span>
          </div>
        </div>
        <!-- Fim primeira linha caixa habilidades -->
        <br />
        <!-- Inicio caixas de descrição -->
        <div class="caixa_tabela_linha">
          <span class="informacao_tabela">
            <div class="caixa_tabela">
              <div class="caixa_tabela_linha">
                <span class="informacao_tabela">
                  <textarea
                    class="descricao_habilidade"
                    name="attr_descricao_habilidade"
                    type="text"
                    placeholder="especializações">
                  </textarea>
                </span>
              </div>
            </div>
          </span>
          <br />
        </div>
        <!-- Fim caixas de descrição -->
      </fieldset>
      XP Total
      <input
        name="attr_xp_total_habilidades"
        type="number"
        value="0"
        readonly
      />
    </div>
    <!-- Fim sheet-col -->
    <!-- Fim habilidades -->
  </div>
  <!-- Fim sheet-2colrow bot-margin -->
</div>
<!-- Fim principal -->

<!-- JS -->
<script type="text/worker">
  //Calculo XP Total Atributos
  on("change:for_xp change:agi_xp change:vig_xp change:int_xp change:per_xp change:von_xp sheet:opened", function() {
      getAttrs(["for_xp", "agi_xp", "vig_xp", "int_xp", "per_xp", "von_xp"], function(values) {
          let for_xp = parseInt(values.for_xp) || 0;
          let agi_xp = parseInt(values.agi_xp) || 0;
          let vig_xp = parseInt(values.vig_xp) || 0;
          let int_xp = parseInt(values.int_xp) || 0;
          let per_xp = parseInt(values.per_xp) || 0;
          let von_xp = parseInt(values.von_xp) || 0;

          let xp_total_atributos = for_xp + agi_xp + vig_xp + int_xp + per_xp + von_xp;

          setAttrs({
              "xp_total_atributos": xp_total_atributos
          });
      });
  });

  //Calculo XP Traços e Condições
  on("change:tra_cod_xp sheet:opened", function() {
      getAttrs(["tra_cod_xp"], function(values) {
          let tra_cod_xp = parseInt(values.tra_cod_xp) || 0;

          let xp_total_tracos_condicoes = tra_cod_xp;
          setAttrs({
              "xp_total_tracos_condicoes": xp_total_tracos_condicoes
          });
      });
  });

  //Calculo XP Habilidades
  on("change:hab_xp sheet:opened", function() {
      getAttrs(["hab_xp"], function(values) {
          let hab_xp = parseInt(values.hab_xp) || 0;

          let xp_total_habilidades = hab_xp;
          setAttrs({
              "xp_total_habilidades": xp_total_habilidades
          });
      });
  });

  //Calculo XP Gasto
  on("change:xp_total_atributos change:xp_total_tracos_condicoes change:xp_total_habilidades sheet:opened", function() {
      getAttrs(["xp_total_atributos", "xp_total_tracos_condicoes", "xp_total_habilidades"], function(values) {
          let xp_total_atributos = parseInt(values.xp_total_atributos) || 0;
          let xp_total_tracos_condicoes = parseInt(values.xp_total_tracos_condicoes) || 0;
          let xp_total_habilidades = parseInt(values.xp_total_habilidades) || 0;

          let xp_gasto_personagem = xp_total_atributos + xp_total_tracos_condicoes + xp_total_habilidades;
          setAttrs({
              "xp_gasto_personagem": xp_gasto_personagem
          });
      });
  });

  //Calculo XP Livre
  on("change:xp_total_personagem change:xp_gasto_personagem sheet:opened", function() {
      getAttrs(["xp_total_personagem", "xp_gasto_personagem"], function(values) {
          let xp_total_personagem = parseInt(values.xp_total_personagem) || 0;
          let xp_gasto_personagem = parseInt(values.xp_gasto_personagem) || 0;

          let xp_livre_personagem = xp_total_personagem - xp_gasto_personagem;

          setAttrs({
              "xp_livre_personagem": xp_livre_personagem
          });
      });
  });

  //Calculo Atributos Base
  on("change:idade_personagem sheet:opened", function() {
      getAttrs(["idade_personagem"], function(values) {
          let idade_personagem = parseInt(values.idade_personagem) || 0;
          let base = 0;

          if (idade_personagem <= 17)
              base = Math.floor((idade_personagem - 1) / 2);
          else
              base = 8;

          setAttrs({
              "base": base
          });
      });
  });

  //Calculo Força
  on("change:base change:for_nivel change:for_mod sheet:opened", function() {
      getAttrs(["base", "for_nivel", "for_mod"], function(values) {
          let base = parseInt(values.base) || 0;
          let for_nivel = parseInt(values.for_nivel) || 0;
          let for_mod = parseInt(values.for_mod) || 0;

          let for_total = base + for_nivel + for_mod;

          setAttrs({
              "for_total": for_total
          });
      });
  });

  //Calculo Porcentagem Força
  on("change:for_total sheet:opened", function() {
      getAttrs(["for_total"], function(values) {
          let for_total = parseInt(values.for_total) || 0;

          let for_porcent = for_total * 4;

          setAttrs({
              "for_porcent": for_porcent
          });
      });
  });

  //Calculo Agilidade
  on("change:base change:agi_nivel change:agi_mod sheet:opened", function() {
      getAttrs(["base", "agi_nivel", "agi_mod"], function(values) {
          let base = parseInt(values.base) || 0;
          let agi_nivel = parseInt(values.agi_nivel) || 0;
          let agi_mod = parseInt(values.agi_mod) || 0;

          let agi_total = base + agi_nivel + agi_mod;

          setAttrs({
              "agi_total": agi_total
          });
      });
  });

  //Calculo Porcentagem Agilidade
  on("change:agi_total sheet:opened", function() {
      getAttrs(["agi_total"], function(values) {
          let agi_total = parseInt(values.agi_total) || 0;

          let agi_porcent = agi_total * 4;

          setAttrs({
              "agi_porcent": agi_porcent
          });
      });
  });

  //Calculo Vigor
  on("change:base change:vig_nivel change:vig_mod sheet:opened", function() {
      getAttrs(["base", "vig_nivel", "vig_mod"], function(values) {
          let base = parseInt(values.base) || 0;
          let vig_nivel = parseInt(values.vig_nivel) || 0;
          let vig_mod = parseInt(values.vig_mod) || 0;

          let vig_total = base + vig_nivel + vig_mod;

          setAttrs({
              "vig_total": vig_total
          });
      });
  });

  //Calculo Porcentagem Vigor
  on("change:vig_total sheet:opened", function() {
      getAttrs(["vig_total"], function(values) {
          let vig_total = parseInt(values.vig_total) || 0;

          let vig_porcent = vig_total * 4;

          setAttrs({
              "vig_porcent": vig_porcent
          });
      });
  });

  //Calculo Intelecto
  on("change:base change:int_nivel change:int_mod sheet:opened", function() {
      getAttrs(["base", "int_nivel", "int_mod"], function(values) {
          let base = parseInt(values.base) || 0;
          let int_nivel = parseInt(values.int_nivel) || 0;
          let int_mod = parseInt(values.int_mod) || 0;

          let int_total = base + int_nivel + int_mod;

          setAttrs({
              "int_total": int_total
          });
      });
  });

  //Calculo Porcentagem Intelecto
  on("change:int_total sheet:opened", function() {
      getAttrs(["int_total"], function(values) {
          let int_total = parseInt(values.int_total) || 0;

          let int_porcent = int_total * 4;

          setAttrs({
              "int_porcent": int_porcent
          });
      });
  });

  //Calculo Percepção
  on("change:base change:per_nivel change:per_mod sheet:opened", function() {
      getAttrs(["base", "per_nivel", "per_mod"], function(values) {
          let base = parseInt(values.base) || 0;
          let per_nivel = parseInt(values.per_nivel) || 0;
          let per_mod = parseInt(values.per_mod) || 0;

          let per_total = base + per_nivel + per_mod;

          setAttrs({
              "per_total": per_total
          });
      });
  });

  //Calculo Porcentagem Percepção
  on("change:per_total sheet:opened", function() {
      getAttrs(["per_total"], function(values) {
          let per_total = parseInt(values.per_total) || 0;

          let per_porcent = per_total * 4;

          setAttrs({
              "per_porcent": per_porcent
          });
      });
  });

  //Calculo Vontade
  on("change:base change:von_nivel change:von_mod sheet:opened", function() {
      getAttrs(["base", "von_nivel", "von_mod"], function(values) {
          let base = parseInt(values.base) || 0;
          let von_nivel = parseInt(values.von_nivel) || 0;
          let von_mod = parseInt(values.von_mod) || 0;

          let von_total = base + von_nivel + von_mod;

          setAttrs({
              "von_total": von_total
          });
      });
  });

  //Calculo Porcentagem Vontade
  on("change:von_total sheet:opened", function() {
      getAttrs(["von_total"], function(values) {
          let von_total = parseInt(values.von_total) || 0;

          let von_porcent = von_total * 4;

          setAttrs({
              "von_porcent": von_porcent
          });
      });
  });

  //Calculo Vitalidade Base
  on("change:vig_total sheet:opened", function() {
      getAttrs(["vig_total"], function(values) {
          let vig_total = parseInt(values.vig_total) || 0;

          let sub_vit_base = vig_total * 2;

          setAttrs({
              "sub_vit_base": sub_vit_base
          });
      });
  });

  //Calculo Vitalidade Total
  on("change:sub_vit_base change:sub_vit_mod sheet:opened", function() {
      getAttrs(["sub_vit_base", "sub_vit_mod"], function(values) {
          let sub_vit_base = parseInt(values.sub_vit_base) || 0;
          let sub_vit_mod = parseInt(values.sub_vit_mod) || 0;

          let sub_vit_total = sub_vit_base + sub_vit_mod;

          setAttrs({
              "sub_vit_total": sub_vit_total
          });
      });
  });

  //Calculo Iniciativa Base
  on("change:for_total sheet:opened", function() {
      getAttrs(["agi_total"], function(values) {
          let agi_total = parseInt(values.agi_total) || 0;

          let sub_ini_base = agi_total * 2;

          setAttrs({
              "sub_ini_base": sub_ini_base
          });
      });
  });

  //Calculo Iniciativa Total
  on("change:sub_ini_base change:sub_ini_mod sheet:opened", function() {
      getAttrs(["sub_ini_base", "sub_ini_mod"], function(values) {
          let sub_ini_base = parseInt(values.sub_ini_base) || 0;
          let sub_ini_mod = parseInt(values.sub_ini_mod) || 0;

          let sub_ini_total = sub_ini_base + sub_ini_mod;

          setAttrs({
              "sub_ini_total": sub_ini_total
          });
      });
  });

  //Calculo Mod de Dano Base
  on("change:for_total sheet:opened", function() {
      getAttrs(["for_total"], function(values) {
          let for_total = parseInt(values.for_total) || 0;

          let sub_mod_dano_base = Math.floor((for_total - 10) / 2);

          setAttrs({
              "sub_mod_dano_base": sub_mod_dano_base
          });
      });
  });

  //Calculo Mod de Dano Total
  on("change:sub_mod_dano_base change:sub_mod_dano_mod sheet:opened", function() {
      getAttrs(["sub_mod_dano_base", "sub_mod_dano_mod"], function(values) {
          let sub_mod_dano_base = parseInt(values.sub_mod_dano_base) || 0;
          let sub_mod_dano_mod = parseInt(values.sub_mod_dano_mod) || 0;

          let sub_mod_dano_total = sub_mod_dano_base + sub_mod_dano_mod;

          setAttrs({
              "sub_mod_dano_total": sub_mod_dano_total
          });
      });
  });

  //Calculo Sanidade Base
  on("change:von_total sheet:opened", function() {
      getAttrs(["von_total"], function(values) {
          let von_total = parseInt(values.von_total) || 0;

          let sub_san_base = von_total * 2;

          setAttrs({
              "sub_san_base": sub_san_base
          });
      });
  });

  //Calculo Sanidade Total
  on("change:sub_san_base change:sub_san_mod sheet:opened", function() {
      getAttrs(["sub_san_base", "sub_san_mod"], function(values) {
          let sub_san_base = parseInt(values.sub_san_base) || 0;
          let sub_san_mod = parseInt(values.sub_san_mod) || 0;

          let sub_san_total = sub_san_base + sub_san_mod;

          setAttrs({
              "sub_san_total": sub_san_total
          });
      });
  });

  //Calculo Raciocinio Base
  on("change:per_total sheet:opened", function() {
      getAttrs(["per_total"], function(values) {
          let per_total = parseInt(values.per_total) || 0;

          let sub_rac_base = per_total * 2;

          setAttrs({
              "sub_rac_base": sub_rac_base
          });
      });
  });

  //Calculo Raciocinio Total
  on("change:sub_rac_base change:sub_rac_mod sheet:opened", function() {
      getAttrs(["sub_rac_base", "sub_rac_mod"], function(values) {
          let sub_rac_base = parseInt(values.sub_rac_base) || 0;
          let sub_rac_mod = parseInt(values.sub_rac_mod) || 0;

          let sub_rac_total = sub_rac_base + sub_rac_mod;

          setAttrs({
              "sub_rac_total": sub_rac_total
          });
      });
  });

  //Calculo Estresse Base
  on("change:int_total sheet:opened", function() {
      getAttrs(["int_total"], function(values) {
          let int_total = parseInt(values.int_total) || 0;

          let sub_est_base = Math.floor((int_total - 10 ) / 2);

          setAttrs({
              "sub_est_base": sub_est_base
          });
      });
  });

  //Calculo Estresse Total
  on("change:sub_est_base change:sub_est_mod sheet:opened", function() {
      getAttrs(["sub_est_base", "sub_est_mod"], function(values) {
          let sub_est_base = parseInt(values.sub_est_base) || 0;
          let sub_est_mod = parseInt(values.sub_est_mod) || 0;

          let sub_est_total = sub_est_base + sub_est_mod;

          setAttrs({
              "sub_est_total": sub_est_total
          });
      });
  });

  //Código para fazer contas com fieldsets
  const repeatingSum = (destinations, section, fields, ...extras) => {
    const isNumber = value => parseFloat(value).toString() === value.toString();
    const isOption = value => [...checks.valid, ...checks.roundtypes].includes(value);
    const isRounding = value => checks.roundtypes.includes(value);
    const isFraction = value => value.includes('/') && !(value.includes(',') || value.includes('|'));
    const getTrimmed = value => value.toLowerCase().replace(/\s/g, '');
    const getRounded = (type, value, pow) => (Math[type](value * Math.pow(10, pow)) / Math.pow(10, pow)).toFixed(Math.max(0, pow));
    const getFraction = (value) => /*{ console.log(`value: ${value}`); */
        parseInt(value.split('/')[0]) / parseInt(value.split('/')[1]);
    const getMultiplier = (value, rounding = 1) => 'undefined' === typeof value ? (rounding ? 0: 1) : (
        isNumber(value) ? parseFloat(value) : (isFraction(value) ? getFraction(value) : value));
    if (!Array.isArray(destinations)) destinations = [getTrimmed(destinations)];
    if (!Array.isArray(fields)) fields = [getTrimmed(fields)];
    const fields_trimmed = fields.map(field => getTrimmed(field).split(':')[0]);
    const subfields = fields_trimmed.slice(0,destinations.length);
    const checks = { valid: ['multiplier'], roundtypes: ['ceil', 'round', 'floor'] };
    let properties = {attributes: {}, options: {}};
    extras.forEach(extra => {
        const [prop, v] = getTrimmed(extra).split(':');
        const multiplier_maybe = getMultiplier(v, isRounding(prop));
        const obj = isNumber(multiplier_maybe) ? subfields.reduce((obj,field) => {
            obj[field] = multiplier_maybe;
            return obj;
        },{}) : multiplier_maybe.split(',').reduce((obj, item) => {
            const [stat, value] = item.split('|');
            const multiplier = getMultiplier(value, isRounding(prop));
            obj[stat] = multiplier;
            return obj;
        }, {});
        properties[isOption(prop) ? 'options' : 'attributes'][prop] = obj;
    });
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce((m, id) => [...m, ...(fields_trimmed.map(field => `repeating_${section}_${id}_${field}`))], []);
        getAttrs([...attrArray, ...Object.keys(properties.attributes)], v => {
            const getValue = (section, id, field) => v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : parseFloat(v[`repeating_${section}_${id}_${field}`]) || 0;
            const commonMultipliers = (fields.length <= destinations.length) ? [] : fields.splice(destinations.length, fields.length - destinations.length);
            const output = destinations.reduce((obj, destination, index) => {
                let sumTotal = idArray.reduce((total, id) => total + getValue(section, id, fields_trimmed[index]) * commonMultipliers.reduce((subtotal, mult) => subtotal * ((!mult.includes(':') || mult.split(':')[1].split(',').includes(fields_trimmed[index])) ? getValue(section, id, mult.split(':')[0]) : 1), 1), 0);
                sumTotal *= (properties.options.hasOwnProperty('multiplier') && Object.keys(properties.options.multiplier).includes(fields_trimmed[index])) ? (parseFloat(properties.options.multiplier[fields_trimmed[index]]) || 0): 1;
                sumTotal += Object.entries(properties.attributes).reduce((total, [key, value]) =>
                    total += (value.hasOwnProperty(fields_trimmed[index]) ? parseFloat(v[key] || 0) * (parseFloat(value[fields_trimmed[index]]) || 1): 0) , 0);
                checks.roundtypes.forEach(type => {
                    if (properties.options.hasOwnProperty(type)) {
                        if (Object.keys(properties.options[type]).includes(fields_trimmed[index])) {
                            sumTotal = getRounded(type, sumTotal, (+properties.options[type][fields_trimmed[index]] || 0));
                        } else if (properties.options[type] == '0' || !isNaN(+properties.options[type] || 'x') ) {
                            sumTotal = getRounded(type, sumTotal, +properties.options[type]);
                        }
                    }
                });
                obj[destination] = sumTotal;
                return obj;
            }, {});
            setAttrs(output);
        });
    });
  };

  //Calculo XP Traços e Condições
  on("change:repeating_caixatracoscondicoes:xp_traco_condicao remove:repeating_caixatracoscondicoes sheet:opened", function() {
    repeatingSum("xp_total_tracos_condicoes", "caixatracoscondicoes", "xp_traco_condicao")
  });

  //Calculo XP Habilidade
  on("change:repeating_caixahabilidades:hab_xp remove:repeating_caixahabilidades sheet:opened", function() {
    repeatingSum("xp_total_habilidades", "caixahabilidades", "hab_xp")
  });
</script>
